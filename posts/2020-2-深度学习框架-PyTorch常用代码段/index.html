<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>æ·±åº¦å­¦ä¹ æ¡†æ¶</title>

        <link rel="stylesheet" href="../../fonts/Serif/cmun-serif.css" />
        <link rel="stylesheet" href="../../fonts/Serif-Slanted/cmun-serif-slanted.css" />

        <!--BOOTSTRAP-->
        <link href="../../bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!--mobile first-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!--removed html from url but still is html-->
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <!--font awesome-->
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

        <!--fonts: allan & cardo-->
        <link href="http://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Droid+Sans" rel="stylesheet" type="text/css">

        <link href="../../css/sticky-footer-navbar.css" rel="stylesheet">

        <link href="../../css/default.css" rel="stylesheet">

        <link href="../../comments/inlineDisqussions.css" rel="stylesheet">

        <!--Highlight-->
        <link href="../../highlight/styles/github.css" rel="stylesheet">

        <link href="../../favicon.ico" rel="shortcut icon" />

        <!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
        <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <style>
        .post{width:170px;min-height:175px;padding-left:5px;padding-right:5px;float:left;border-left:1px solid #CCC;background-color:white;}
        div a:first-of-type .post { border-left: none; }
        .post:hover {filter: brightness(90%);}
        .post h3{margin:5px;font-size:75%;text-align:center}
        .post h4{margin:0px;font-size:50%;text-align:center}
        .post img{margin:0px;padding:2px;margin-bottom:10px;width:100%;height:155px}
        </style>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-49811703-1', 'dwHou.github.io');
          ga('require', 'linkid', 'linkid.js');
          ga('require', 'displayfeatures');
          ga('send', 'pageview');

        </script>

    </head>

    <body>
        <div id="wrap">
            <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
                <div class="container">
                    <!--Toggle header for mobile-->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand active" href="../../" style="font-size:20px;">De's blog</a>
                    </div>
                    <!--normal header-->
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="../../"><span class="glyphicon glyphicon-pencil"></span>  Blog</a></li>
                            <li><a href="../../about.html"><span class="glyphicon glyphicon-user"></span>  About</a></li>
                            <li><a href="../../contact.html"><span class="glyphicon glyphicon-envelope"></span>  Contact</a></li>
                            <li><a href="../../demo.html"><span class="glyphicon glyphicon-play"></span>  ALGO</a></li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </nav>


            <div id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-md-8">
                            <h1>PyTorch</h1>
                            <div style="font-size: 170%;">æŒç»­æ›´æ–°</div>
                            <br>
                            <div class="info">
    <p style="font-family:CMSS; font-size:120%">Posted on Feb.19, 2020</p>

    <!--
        by dwHou
    -->
</div>
</br>


  <style>
    ul li {
      margin-top: 12px;
    }

    .tight-list li {
      margin-top: 6px;
    }
  </style>


  <h2>Pytorchå¸¸ç”¨ä»£ç æ®µ</h2>
  <ul>

  <li><a href="./PyTorchå¸¸ç”¨ä»£ç æ®µ.html"> ğŸ““Cookbook </a></li>
    
  </ul>


  <h2>æ¡†æ¶ä½¿ç”¨ç»éªŒ</h2>
  <ul>

  </ul>

  <h2>é‡åˆ°çš„å‘/bug</h2>
  <ul>
      <li>in-placeæ“ä½œ</li>
      in-place operationåœ¨pytorchä¸­æ˜¯æŒ‡æ”¹å˜ä¸€ä¸ªtensorçš„å€¼çš„æ—¶å€™ï¼Œä¸ç»è¿‡å¤åˆ¶æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åœ¨åŸæ¥çš„å†…å­˜ä¸Šæ”¹å˜å®ƒçš„å€¼ã€‚å¯ä»¥æŠŠå®ƒæˆä¸ºåŸåœ°æ“ä½œç¬¦ã€‚
      åœ¨pytorchä¸­ç»å¸¸åŠ åç¼€â€œ_â€æ¥ä»£è¡¨åŸåœ°in-place operationï¼Œæ¯”å¦‚è¯´.add_() æˆ–è€….scatter()ã€‚pythoné‡Œé¢çš„+=ï¼Œ*=ä¹Ÿæ˜¯in-place operationã€‚
      PyTorchæ—§ç‰ˆæœ¬æœ‰æç¤ºï¼šé™¤éæ‚¨åœ¨å†…å­˜å‹åŠ›å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¦åˆ™æ‚¨å¯èƒ½æ°¸è¿œä¸éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚
      å½“æ—¶çš„åŸå› æ˜¯ï¼‘ï¼è¦†ç›–æ¢¯åº¦è®¡ç®—æ‰€éœ€çš„å€¼ã€‚ï¼’ï¼æ¯ä¸ªin-placeæ“ä½œå®é™…ä¸Šéœ€è¦å®ç°é‡å†™è®¡ç®—å›¾ã€‚
      <pre>
          å·ç§¯è¿™äº›æ“ä½œä¸æ˜¯in-placeï¼Œ
          reluå¯é€‰in-placeï¼Œ
          -=,+=è¿™ç±»æ˜¯in-placeï¼Œ
          CAINå®ç°çš„æ”¹ç‰ˆçš„meanshiftâ€”â€”sub_mean()å°±ä¹Ÿæ˜¯in-placeçš„ã€‚
          å› ä¸ºä½ è¿›å…¥ç½‘ç»œå°±è¿›è¡Œäº†åŸåœ°æ“ä½œï¼Œæ‰€ä»¥prediction = model(input)ä¼šæ”¹åŠ¨åˆ°input.
          è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œè¿›å…¥ç½‘ç»œå
          foward(x):
                x = x.clone()
          RCANã€EDSRè¿™äº›DIV2kæ•°æ®é›†ä¸Šçš„Meanshiftæ˜¯ç”¨å·ç§¯æ–¹å¼å®ç°çš„ï¼Œå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚

          <font color="red">æ€»ç»“:</font> ä¸æƒ³å—åˆ°in-placeå½±å“çš„å˜é‡ï¼Œå¯ä»¥æ‹·è´x.copy()ï¼Œæˆ–è€…å¦‚æœæ˜¯å¼ é‡å¯ä»¥x.clone()ã€‚
      </pre>
      <li>åˆå§‹åŒ–</li>
      <pre>PyTorch Moduleè‡ªå¸¦çš„é»˜è®¤åˆå§‹åŒ–æ–¹æ³•å¾€å¾€æ›´å¯é ã€‚</pre>
      <li>æ•°æ®é›†è¾“å…¥é—®é¢˜</li>
      <pre>æŠŠè®­ç»ƒé›†dataloaderçš„shuffleå…³æ‰ï¼Œæº¯æºæ‰¾åˆ°æ•°æ®é›†å¯¹åº”å…ƒç´ ã€‚ä¾‹å¦‚ä¼˜é…·è¶…åˆ†æ•°æ®é›†å°±æœ‰2048x1152åˆ†è¾¨ç‡çš„è§†é¢‘ã€‚
           è¦è®°å¾—æ•°æ®é›†æ˜¯æœ‰shuffleçš„ï¼Œåœ¨å¤„ç†æ•°æ®é€»è¾‘æ—¶ä¸€å®šè¦æ„è¯†åˆ°ã€‚
      </pre>
      <li>æ¨¡å‹éªŒè¯é›†æŒºå¥½çš„ï¼Œç»“æœæµ‹è¯•è‰²åã€å¤±çœŸç‰¹åˆ«å¥‡æ€ª</li>
      <pre>å¾ˆæœ‰å¯èƒ½å°±æ˜¯å¿˜äº†model.load_state_dict()ï¼Œæ˜¯æŒ‰é»˜è®¤åˆå§‹åŒ–è·‘çš„å›¾ç‰‡ã€‚psnrç›´æ¥ä¼šé™åˆ°åå‡ äºŒåã€‚</pre>
      <li>PyTorchæµ‹è¯•æ¨¡å‹æ‰§è¡Œè®¡ç®—è€—è´¹çš„æ—¶é—´</li>
      <pre>
          <font color="#D2B4DE">ä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨è¿™ç§æ–¹å¼ä¸€æµ‹è¯•æ—¶é—´</font>

          # æ–¹å¼ä¸€:
          star = time.time()
          result = model(input)
          end = time.time()

          <font color="#D2B4DE">ä½†æ­£ç¡®çš„åº”è¯¥æ˜¯ä¸‹è¾¹è¿™ç§æ–¹å¼äºŒ</font>

          # æ–¹å¼äºŒ:
          torch.cuda.synchronize()
          start = time.time()
          result = model(input)
          torch.cuda.synchronize()
          end = time.time()

          <font color="#D2B4DE">ä¸ºä»€ä¹ˆè¿™æ ·å‘¢ï¼Ÿ
          åœ¨pytorché‡Œé¢ï¼Œç¨‹åºçš„æ‰§è¡Œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¦‚æœé‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œæµ‹è¯•çš„æ—¶é—´ä¼šå¾ˆçŸ­ï¼Œå› ä¸ºæ‰§è¡Œå®Œend=time.time()ç¨‹åºå°±é€€å‡ºäº†ï¼Œåå°çš„cuä¹Ÿå› ä¸ºpythonçš„é€€å‡ºé€€å‡ºäº†ï¼›
              å¦‚æœé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œä»£ç ä¼šåŒæ­¥cuçš„æ“ä½œï¼Œç­‰å¾…gpuä¸Šçš„æ“ä½œéƒ½å®Œæˆäº†å†ç»§ç»­è®¡ç®—end = time.time()</font>

          <font color="#D2B4DE">å¦‚æœå°†æ–¹å¼ä¸€ä»£ç æ”¹ä¸ºæ–¹å¼ä¸‰ï¼š</font>

          # æ–¹å¼ä¸‰:
          start = time.time()
          result = model(input)
          print(result) #æˆ– result.cpu()
          end = time.time()

          <font color="#D2B4DE">è¿™æ—¶å€™ä¼šå‘ç°æ–¹å¼ä¸‰å’Œæ–¹å¼äºŒçš„æ—¶é—´æ˜¯ç±»ä¼¼çš„ï¼Œå› ä¸ºæ–¹å¼ä¸‰ä¼šç­‰å¾…gpuä¸Šçš„ç»“æœæ‰§è¡Œå®Œä¼ ç»™printå‡½æ•°ï¼Œæ‰€ä»¥æ­¤æ—¶é—´å°±å’Œæ–¹å¼äºŒåŒæ­¥æ“ä½œçš„æ—¶é—´åŸºæœ¬ä¸Šæ˜¯ä¸€è‡´çš„äº†ã€‚
              å°†print(result)æ¢æˆresult.cpu()ä¹Ÿå¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æœã€‚</font>


          <font color="#D2B4DE">æ¥è‡ªä½œè€…ï¼šå‡ æ—¶è§å¾—æ¸…æ¢¦ çš„ç®€ä¹¦ç¬”è®°</font>

      </pre>
      <li>torch.cuda.synchronize()</li>
        ç­‰å¾…å½“å‰è®¾å¤‡ä¸Šæ‰€æœ‰æµä¸­çš„æ‰€æœ‰æ ¸å¿ƒå®Œæˆã€‚ å¦‚æœä¸åŠ syn, forwardä¼šé©¬ä¸Šè¿”å›ã€‚
        ä½†åŠ ä¸Šsynåï¼Œcpuä¼šç­‰å¾…æ¨¡å‹å®é™…è¿è¡Œå®Œå†è·å–æ•°æ®.å®é™…ä½¿ç”¨æ—¶ï¼Œå¦‚æœä¸é€æ®µç»Ÿè®¡æ—¶é—´ï¼Œå¯ä»¥ä¸åŠ è¿™ä¸ªsync.
        <pre>

            #<font color="#D4E6F1"></font>
            <font color="#2E86C1">
            from contextlib import contextmanager

            @contextmanager
            def timer(self, name):
                start = torch.cuda.Event(enable_timing=True)
                end = torch.cuda.Event(enable_timing=True)

                start.record()
                yield
                end.record()

                torch.cuda.synchronize()
                print(f'[{name}] done in {start.elapsed_time(end):.3f} ms')

            with timer('GTX 1080 Ti 720p inference'):
                    out = model(input)
            </font>
            è¿™æ ·ç»“æœæ‰ä¸€è‡´çš„æƒ¹ã€‚
        </pre>
      <li>å¯¹æ¯”è¯•éªŒçš„ä¼˜åŒ–å™¨å’Œlræ›´æ–°ç­–ç•¥</li>
      <pre>â‘ ä¸ä½¿ç”¨scheduler, Adam + ä¸€ä¸ªå¤§çš„epochè®­ä¸‹å»ã€‚è¿™æ ·æ¯”è¾ƒå…¬å¹³ã€‚
           â‘¡ReduceLROnPlateauæœ‰ç‚¹è¿æ°”æˆåˆ†ï¼Œè¦ä¹ˆå°±åœ¨lossæ˜¯å¦ä¸‹é™ä¸Šåšã€‚å¦‚æœæ˜¯éªŒè¯é›†PSNRï¼Œé‚£æœ€å¥½å°†å®¹å¿åº¦è®¾å¾ˆå¤§ã€‚
           â‘¢ä½™å¼¦é€€ç«ã€‚ç­–ç•¥ä¸€è‡´å°±æ˜¯å¯ä»¥çš„ã€‚
      </pre>

      <li>train ä¸ val çš„åŒºåˆ«</li>
      <pre>
          model.train() ï¼šå¯ç”¨ BatchNormalization å’Œ Dropout
          model.eval() ï¼šä¸å¯ç”¨ BatchNormalization å’Œ Dropout
          valæ—¶ä¼šåŠ ä¸Š with torch.no_grad()
      </pre>

      <li> torch.nn ä¸ torch.nn.functional</li>
      <pre>

      </pre>

      <li>æ¨¡å‹å’Œä¿å­˜ç‚¹ä¸åŒ¹é…</li>
      <pre>
          åœ¨æ’é™¤äº†GPU/CPUå’Œå•å¡å¤šå¡çš„é—®é¢˜ä¹‹åï¼Œæ€€ç–‘åˆ°æ˜¯ä»£ç å˜åŠ¨ã€‚
              state_dict = torch.load(arg.ckp)
              from collections import OrderedDict
              new_state_dict = OrderedDict()
              for k, v in state_dict.items():
                  name = k[7:] # remove 'module'.
                  new_state_dict[name] = v
              print(new_state_dict.keys())
          å°†ç»“æœè¾“å‡ºåˆ° > module.txtçœ‹ï¼Œå®½åº¦ç¼©å°åˆ°å•æ ï¼Œç„¶åé¡ºç€ç½‘ç»œå±‚æ’æŸ¥æ˜¯å“ªå„¿çš„ä»£ç æ²¡å¯¹ä¸Šã€‚
      </pre>

  </ul>



<!-- åŠ è½½å‡ºè¯„è®ºï¼Œæ˜¯ä½¿ç”¨Disqusçš„è®ºå›çŸ­åï¼ˆshortnameï¼‰
A shortname is the unique identifier assigned to a Disqus site. 

https://segmentfault.com/a/1190000005773009
https://help.disqus.com/en/articles/1717111-what-s-a-shortname
https://blog.csdn.net/weixin_34327761/article/details/89630337
   -->

<div id="disqus_thread"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

<script src="../../comments/inlineDisqussions.js"></script>
<script src="../../js/disqus.js"></script>

                        </div>
                        <div class="col-md-4"></div>
                    </div>
                </div>
            </div>


            <div id="footer">
                <div class="container">
                    Built by <a href="https://github.com/oinkina">Oinkina</a> with
                    <a href="http://jaspervdj.be/hakyll">Hakyll</a>
                    using <a href="http://getbootstrap.com/">Bootstrap</a>,
                    <a href="http://www.mathjax.org/">MathJax</a>,
                    <a href="http://disqus.com/">Disqus</a>,
                    <a href="https://github.com/unconed/MathBox.js">MathBox.js</a>,
                    <a href="http://highlightjs.org/">Highlight.js</a>,
                    and <a href="http://ignorethecode.net/blog/2010/04/20/footnotes/">Footnotes.js</a>.
                </div>
            </div>
        </div>

    <!-- jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script src="../../bootstrap/js/bootstrap.min.js"></script>

    <script src="../../highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="../../js/footnotes.js"></script>

    <script src="../../comments/inlineDisqussions.js"></script>

    <noscript>Enable JavaScript for footnotes, Disqus comments, and other cool stuff.</noscript>

    </body>

</html>
